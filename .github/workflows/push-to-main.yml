name: push-to-main
on:
  push:
    branches:
      - main
concurrency:
  # Cancel other jobs in the same branch. We don't care whether CI passes
  # on old commits.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}
env:
  MODIN_GITHUB_CI: true
jobs:
  test-ray-master:
    runs-on: ubuntu-latest
    defaults:
      run:
        # `shell: bash -l {0}` - special way to activate modin environment
        shell: bash -l {0}
    services:
      moto:
        image: motoserver/moto:5.0.13
        ports:
          - 5000:5000
        env:
          AWS_ACCESS_KEY_ID: foobar_key
          AWS_SECRET_ACCESS_KEY: foobar_secret
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/mamba-env
        with:
          environment-file: environment-dev.yml
      - name: install Ray nightly build
        # Use --force-reinstall to always reinstall ray and its dependencies.
        # botocore isn't compatible with urllib3>=2; see #6094 for details
        run: pip install --force-reinstall "urllib3<2" https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-3.0.0.dev0-cp39-cp39-manylinux2014_x86_64.whl
      - name: Conda environment
        run: |
          conda info
          conda list
      - run: sudo apt update && sudo apt install -y libhdf5-dev
      - name: Run parallelizable Modin Tests
        run: >
          python -m pytest -n 2
          modin/tests/pandas/dataframe/test_binary.py
          modin/tests/pandas/dataframe/test_default.py
          modin/tests/pandas/dataframe/test_indexing.py
          modin/tests/pandas/dataframe/test_iter.py
          modin/tests/pandas/dataframe/test_join_sort.py
          modin/tests/pandas/dataframe/test_map_metadata.py
          modin/tests/pandas/dataframe/test_reduce.py
          modin/tests/pandas/dataframe/test_udf.py
          modin/tests/pandas/dataframe/test_window.py
          modin/tests/pandas/test_series.py
          modin/tests/numpy/test_array.py
          modin/tests/numpy/test_array_creation.py
          modin/tests/numpy/test_array_arithmetic.py
          modin/tests/numpy/test_array_axis_functions.py
          modin/tests/numpy/test_array_logic.py
          modin/tests/numpy/test_array_linalg.py
          modin/tests/numpy/test_array_indexing.py
          modin/tests/numpy/test_array_math.py
          modin/tests/numpy/test_array_shaping.py
          modin/tests/pandas/test_rolling.py
          modin/tests/pandas/test_expanding.py
          modin/tests/pandas/test_concat.py
          modin/tests/pandas/test_groupby.py
          modin/tests/pandas/test_reshape.py
          modin/tests/pandas/test_general.py
      - name: Run non-parallelizable Modin Tests
        run: >
          python -m pytest
          modin/tests/pandas/test_io.py
          modin/tests/experimental/test_io_exp.py

  test-docs:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    name: test docs
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/mamba-env
        with:
          environment-file: environment-dev.yml
      - run: sudo apt update && sudo apt install -y libhdf5-dev
      - name: Docstring URL validity check
        run: python -m pytest modin/tests/test_docstring_urls.py
